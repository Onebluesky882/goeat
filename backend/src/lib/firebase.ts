// src/lib/firebase.ts
import { cert, getApps, initializeApp } from 'firebase-admin/app';
import { getMessaging } from 'firebase-admin/messaging';

// todo  .env error
const FIREBASE_SERVICE_ACCOUNT_BASE64 =
  'ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAibWVudXgtYThmMjkiLAogICJwcml2YXRlX2tleV9pZCI6ICIwZWNmYTI2NzYyZTgwOTcyOGI3MmRkNGMwMDk2MzYyNzBkYzE5ZWZkIiwKICAicHJpdmF0ZV9rZXkiOiAiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUlFdmdJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLZ3dnZ1NrQWdFQUFvSUJBUUM0VmFmN05XSzNGNVMwXG5mOUZVU3UzNXdibXVhQ0FxUi9TckJPSGg2eks5UGoxSTE5eTR3dTNzVVZqUGkybkx4bGJwRi92L2ZDRHhPZjhOXG5RQjVqYTk0WTNmenFYcmJpSVl1NlVNTDFHN2FQMzluOTlFSVVxeTBXanZNRVFlQnFXcFI5Zjh2OVVNbUFuVXBhXG54SlpFN2RRUFpUVXRuY0gzbWV2Zk5SbUtZQmMrbDhVWEkram5LL3ZuT1FiQTJaMHRPb3lzT25YY0Z4T2IvbTliXG5pV0dHcGJJUFNaZ25lUUk2dEpSRklPcWkrd3BIYStzTEcrUUMyT2xma2xadVBWam1hbmJBdEZXeUFGeFZ4dCs4XG5TWm8wNGZKRDloU3h3eHUyL2dNd29NUzVqdFZWV294aExBb1RrVnpEU1BMVU91blYrQ1J5eGdCVmlQL0d4WGY2XG5hU2Z3bHdaUEFnTUJBQUVDZ2dFQU52MmVxa3RuMHBVZlVLV2M3aGVZWE56Vkp0bDdWd0cyVk5xVkJFK2xDRjJyXG43TEl3NzVGL1p2TnhtaURPQS9OOGMvY3F2ekhwcGUwV1VINmpVaWVZenpSU1FoelZWQ3FMdzU1YU9zTDB1SUVnXG5TQ2w1R1M5anVRb1dKMXY3dGQ2bDA3YXZSVGUzbFQzWE03TFgzV0pSMC9IdVpsaGN5Qi9NQlArVFNmdVdrNTR6XG5tTE5sWW5kR3UzQldhaXMydWttS2g3R01Ucm8zZ1lxU0NXR1VIeUJmZFdoaThOOGdYZ2s5cWE4WWlxMURRSjVWXG5FQmo5Q1l6YXhLeW80bmRCR2xCVCswaHg3b0xTQjNEdDZxaUpBVjduUjFpYk16Y1FlMnQwYXppOXc5K1VEbjZ2XG41SXlPTlI3TEZyZ3ZBMytCOGlXbm1PZ3FCRFJrRUFra04wcjJhL0xEZ1FLQmdRRGJaL3VmcnRETkZQRUtLQ3prXG5yVktDZE1aUjB3QVVBMlhLNUhHamxRZER3Q3Z4clErQUZ1dHZQRGtkbndtWmdxSFU0S2l3Ui9UTkd2MzIzVkJWXG51Zi9mSTZMWTJZNnlRMlZYMHZaWFdIeXZnOWJMYkhheFhsdWJNbUR5RXdiUDJNa1RHeXo4YWJPaWl1NUJhVnRJXG50RW4zSmx2WjhRTHA2cGhONlVWelZzeUh3UUtCZ1FEWEZEZDE5c2s4S3ZxUVpQVmFzQjFtY29oWVFDZjZiVmlOXG5rOTErVXZxazNJR2s4VnRXYXJ2aWFlaWZjRFRnRlA3T21nazdHNlRNQld2NzlXN28vY0hIOHMxTis1ZG9PMkR6XG5PTWxjS09EcFhpcjFlTUVaZ3NqZzNpUU0vVGpSSmlvaGtTWldvL0tZc1dEUHVKZXNHOXZhSGttcU5HbEdjamVwXG5rZnRRZU8rU0R3S0JnUUNUem1zdTJlQUVLSlZ4V0R0V0dvVTVLVjNwQlpKSjZUZ01CUFdoVStZKytCa2lpSW1tXG5xc29VZDZlcWt0Y3V1Vmc0UnRpZFdQeExxR0ZxaXhGeGp3b1cwclVFRFJ3YWIxaTRYNEJndTFYVUQ2Y0dCNTIyXG5RM0RIRHB0TXVSQ2Z1TlZNcjhRUWowemF0V2xvVzRlSlpSdG5Da3BhZWdpU2VOMzlycWFBMnZxU2dRS0JnRUJxXG5RYUlHNDRZdHFSV041eDNlR1RBUnBWd28rdEE1NTRlZmZYclVCMVZRNVZNdEpobmZwWjNOOG1tdUJXZ0hZYmttXG4wUlR1MXBCMEh6ODY1cGpKUnp4SEw4M25TQlZqazBuRS9DbXA1SktBTFlXUFFPWVBFWEtubFV4K21vR3BXSHp0XG5KL3BTNTlsclpuOVAzYjBpS3RwTXIrdFYveUdtRzUyaHB3OFc2VWxwQW9HQkFJbXNYNVRWVlhZSUJmTVlRMVBmXG53cjZlUFNuZ0pnNGh2SXdRU29najJFVEQ5NmttUUxOV1U2VU9xMkc1RXloU0dVL1JKclJ2eEpHdkd5Qmk0aDlSXG5jT0pDUnlPUnVuQWMxMFNCeWViMzc1WWpqM1hFb3ZMVGUzVXEvZ1VpdWw0WnZFdndObFdaNE9ONGxyeU9UOFNRXG5aUWVrUEpmTUJZTWNzdDFTU0NGWkNvMERcbi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS1cbiIsCiAgImNsaWVudF9lbWFpbCI6ICJmaXJlYmFzZS1hZG1pbnNkay1mYnN2Y0BtZW51eC1hOGYyOS5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgImNsaWVudF9pZCI6ICIxMDgyNzk3NDYyMjcwMTkwNjczMjAiLAogICJhdXRoX3VyaSI6ICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsCiAgInRva2VuX3VyaSI6ICJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsCiAgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLAogICJjbGllbnRfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9yb2JvdC92MS9tZXRhZGF0YS94NTA5L2ZpcmViYXNlLWFkbWluc2RrLWZic3ZjJTQwbWVudXgtYThmMjkuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJ1bml2ZXJzZV9kb21haW4iOiAiZ29vZ2xlYXBpcy5jb20iCn0K';

if (!FIREBASE_SERVICE_ACCOUNT_BASE64) {
  throw new Error('Missing FIREBASE_SERVICE_ACCOUNT_BASE64 in env');
}

const serviceAccount = JSON.parse(
  Buffer.from(FIREBASE_SERVICE_ACCOUNT_BASE64, 'base64').toString('utf-8'),
);
const app =
  getApps().length === 0
    ? initializeApp({
        credential: cert(serviceAccount),
      })
    : getApps()[0];
const messaging = getMessaging(app);

export { app as firebaseAdmin, messaging };
